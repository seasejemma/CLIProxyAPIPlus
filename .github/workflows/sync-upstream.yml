name: Sync Upstream

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/router-for-me/CLIProxyAPIPlus.git || true
          git fetch upstream --tags

      - name: Sync main branch
        run: |
          git checkout main
          git merge upstream/main --no-edit || echo "No changes or conflicts to resolve"
          
          # Remove upstream workflows to prevent conflicts
          rm -f .github/workflows/docker-image.yml
          rm -f .github/workflows/release.yaml
          rm -f .github/workflows/pr-path-guard.yml
          rm -f .github/workflows/pr-test-build.yml
          
          # Commit removals if any changes
          git add -A
          git diff --cached --quiet || git commit -m "chore: remove upstream workflows"
          
          git push origin main || echo "Nothing to push"

      - name: Push new tags and trigger build
        run: |
          # Push any tags that exist upstream but not in origin
          git tag -l 'v*' | while read tag; do
            if ! git ls-remote --tags origin | grep -q "refs/tags/$tag$"; then
              echo "Pushing new tag: $tag"
              git push origin "$tag" || true
            fi
          done

          # Get latest upstream tag
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -1)
          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found"
            exit 0
          fi

          # Check if image exists in ghcr.io (strip v prefix for image tag)
          VERSION="${LATEST_TAG#v}"
          IMAGE="ghcr.io/${{ github.repository }}:${VERSION}"

          if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
            echo "Image $IMAGE already exists, skipping build"
          else
            echo "Image $IMAGE not found, triggering build for $LATEST_TAG"
            gh workflow run ghcr-hardened.yml -R ${{ github.repository }} -f tag="$LATEST_TAG"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
